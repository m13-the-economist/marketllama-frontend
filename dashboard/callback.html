<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Connecting Account...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <script>
    (async () => {
      try {
        // 1. Extract access_token from URL hash
        const hash = new URLSearchParams(window.location.hash.substring(1));
        const token = hash.get('access_token');

        if (!token) {
          throw new Error('No access token returned from Deriv');
        }

        // 2. Store token immediately
        localStorage.setItem('deriv_token', token);

        // 3. Open Deriv WebSocket
        const ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=117813');

        ws.onopen = () => {
          // 4. Authorize
          ws.send(JSON.stringify({
            authorize: token
          }));
        };

        ws.onmessage = (msg) => {
          const data = JSON.parse(msg.data);

          // 5. Authorization success â†’ fetch accounts
          if (data.msg_type === 'authorize') {
            ws.send(JSON.stringify({
              account_list: 1
            }));
          }

          // 6. Receive account list
          if (data.msg_type === 'account_list') {
            localStorage.setItem(
              'deriv_accounts',
              JSON.stringify(data.account_list)
            );

            ws.close();

            // 7. Redirect to Accounts page
            window.location.href = '/dashboard/accounts.html?connected=true';
          }

          // Handle errors explicitly
          if (data.error) {
            console.error('Deriv error:', data.error);
            alert(data.error.message || 'Deriv connection failed');
          }
        };

        ws.onerror = () => {
          throw new Error('WebSocket connection failed');
        };

      } catch (err) {
        console.error(err);
        alert('Connection failed. Please try again.');
      }
    })();
  </script>
</body>
</html>